{% extends 'base.html' %}
{% load static %}

{% block title %}Supervisor Dashboard - MovieStream{% endblock %}

{% block extra_css %}
<style>
    .dashboard-container {
        padding: 4rem 2rem;
        max-width: 1200px;
        margin: 0 auto;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 2rem;
        margin-bottom: 3rem;
    }

    .stat-card {
        background: var(--dark-lighter);
        padding: 2rem;
        border-radius: 12px;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--primary);
        line-height: 1;
        margin-bottom: 0.5rem;
    }

    .stat-label {
        color: var(--text-secondary);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .movie-table {
        width: 100%;
        background: var(--dark-lighter);
        border-radius: 12px;
        overflow: hidden;
        border-collapse: collapse;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .movie-table th {
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-secondary);
        text-align: left;
        padding: 1.5rem;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 1px;
    }

    .movie-table td {
        padding: 1.5rem;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
        vertical-align: middle;
    }

    .movie-table tr:hover {
        background: rgba(255, 255, 255, 0.02);
    }

    .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
    }

    .status-visible {
        background: rgba(40, 167, 69, 0.1);
        color: #28a745;
        border: 1px solid rgba(40, 167, 69, 0.2);
    }

    .status-hidden {
        background: rgba(229, 9, 20, 0.1);
        color: #e50914;
        border: 1px solid rgba(229, 9, 20, 0.2);
    }

    .btn-toggle {
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 600;
        transition: all 0.2s;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .thumbnail {
        width: 40px;
        height: 60px;
        border-radius: 4px;
        object-fit: cover;
        background: #333;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3rem;">
        <div>
            <h1 style="font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem;">Supervisor Portal</h1>
            <p style="color: var(--text-secondary);">Manage movie visibility and platform content.</p>
        </div>
        <div
            style="background: var(--dark-lighter); padding: 1rem 2rem; border-radius: 50px; border: 1px solid var(--primary);">
            <span style="font-weight: 600;">Welcome, {{ user.username }}</span>
        </div>
    </div>

    <!-- Stats Section -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ movies.count }}</div>
            <div class="stat-label">Total in DB</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="hidden-count-stat">{{ hidden_count }}</div>
            <div class="stat-label">Hidden</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ total_views }}</div>
            <div class="stat-label">Total Traffic</div>
        </div>
    </div>

    <!-- Traffic Chart -->
    <div
        style="background: var(--dark-lighter); padding: 2rem; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 3rem;">
        <h2 style="margin-bottom: 2rem; font-size: 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
            <i class="fas fa-chart-area" style="color: var(--primary);"></i> Platform Traffic (Last 7 Days)
        </h2>
        <div style="height: 300px; width: 100%;">
            <canvas id="trafficChart"></canvas>
        </div>
    </div>

    <!-- Analytics Dashboard -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 3rem;">
        <!-- Top Viewed Movies -->
        <div
            style="background: var(--dark-lighter); padding: 2rem; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">
            <h2 style="margin-bottom: 1.5rem; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-fire" style="color: #ff9800;"></i> Top Trending Content
            </h2>
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                {% for movie in top_movies %}
                <div
                    style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 0.8rem; border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span style="color: var(--text-muted); font-weight: 800; width: 20px;">#{{forloop.counter}}</span>
                        <img src="{{ movie.poster_url }}"
                            style="width: 30px; height: 45px; border-radius: 4px; object-fit: cover;">
                        <span style="font-weight: 600;">{{ movie.title }}</span>
                    </div>
                    <span
                        style="background: rgba(229, 9, 20, 0.1); color: var(--primary); padding: 2px 10px; border-radius: 4px; font-size: 0.8rem; font-weight: 700;">
                        {{ movie.view_count }} views
                    </span>
                </div>
                {% empty %}
                <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">No traffic data yet.</p>
                {% endfor %}
            </div>
        </div>

        <!-- Recent Traffic -->
        <div
            style="background: var(--dark-lighter); padding: 2rem; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">
            <h2 style="margin-bottom: 1.5rem; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-user-clock" style="color: #28a745;"></i> Live Activity Feed
            </h2>
            <div style="display: flex; flex-direction: column; gap: 1.2rem;">
                {% for view in recent_traffic %}
                <div style="display: flex; justify-content: space-between; align-items: start; font-size: 0.9rem;">
                    <div style="display: flex; gap: 1rem;">
                        <div
                            style="width: 8px; height: 8px; border-radius: 50%; background: #28a745; margin-top: 6px; box-shadow: 0 0 8px #28a745;">
                        </div>
                        <div>
                            <span style="color: #fff; font-weight: 600;">{{ view.movie.title }}</span>
                            <br>
                            <small style="color: var(--text-muted);">
                                {% if view.user %}{{ view.user.username }}{% else %}Guest User{% endif %}
                                â€¢ <span style="font-family: monospace;">{{ view.ip_address|default:"127.0.0.1" }}</span>
                            </small>
                        </div>
                    </div>
                    <span style="color: var(--text-muted); font-size: 0.8rem; white-space: nowrap;">
                        {{ view.viewed_at|timesince }} ago
                    </span>
                </div>
                {% empty %}
                <p style="color: var(--text-secondary); text-align: center; padding: 2rem;">No activity recorded.</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Movies Management -->
    <h2 style="margin-bottom: 1.5rem;">Library Management</h2>
    <table class="movie-table">
        <thead>
            <tr>
                <th>Movie</th>
                <th>TMDB ID</th>
                <th>Status</th>
                <th>Actions</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody>
            {% for movie in movies %}
            <tr>
                <td>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <img src="{{ movie.poster_url }}" class="thumbnail" alt="{{ movie.title }}">
                        <span style="font-weight: 600;">{{ movie.title }}</span>
                    </div>
                </td>
                <td style="color: var(--text-secondary); font-family: monospace;">{{ movie.tmdb_id }}</td>
                <td>
                    <span id="badge-{{ movie.tmdb_id }}"
                        class="status-badge {% if movie.is_hidden %}status-hidden{% else %}status-visible{% endif %}">
                        {% if movie.is_hidden %}Hidden{% else %}Visible{% endif %}
                    </span>
                </td>
                <td>
                    <button onclick="toggleHideDashboard({{ movie.tmdb_id }})" id="btn-{{ movie.tmdb_id }}"
                        class="btn-toggle {% if movie.is_hidden %}btn-secondary{% else %}btn-primary{% endif %}"
                        style="{% if not movie.is_hidden %}background: #e50914; border: none; color: white;{% endif %}">
                        {% if movie.is_hidden %}
                        <i class="fas fa-eye"></i> Show
                        {% else %}
                        <i class="fas fa-eye-slash"></i> Hide
                        {% endif %}
                    </button>
                </td>
                <td>
                    <a href="{% url 'movie_detail' movie.tmdb_id %}" style="color: var(--primary); font-size: 0.9rem;">
                        View Page <i class="fas fa-external-link-alt"></i>
                    </a>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" class="text-center" style="padding: 4rem;">
                    No movies found in the database. Movies appear here after they've been visited or added to
                    watchlists.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {{ chart_labels|json_script:"chart-labels-data" }}
    {{ chart_data|json_script:"chart-data-data" }}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Traffic Chart Initialization
    document.addEventListener('DOMContentLoaded', function () {
        const labelsElem = document.getElementById('chart-labels-data');
        const dataElem = document.getElementById('chart-data-data');
        const canvasElem = document.getElementById('trafficChart');

        if (!labelsElem || !dataElem || !canvasElem) return;

        try {
            const chartLabels = JSON.parse(labelsElem.textContent);
            const chartDataValues = JSON.parse(dataElem.textContent);
            const ctx = canvasElem.getContext('2d');

            if (typeof Chart === 'undefined') {
                console.error('Chart.js not loaded');
                return;
            }

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Page Views',
                        data: chartDataValues,
                        borderColor: '#e50914',
                        backgroundColor: 'rgba(229, 9, 20, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#e50914'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            padding: 12,
                            cornerRadius: 8
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.5)',
                                stepSize: 1
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.5)'
                            }
                        }
                    }
                }
            });
        } catch (e) {
            console.error('Error initializing traffic chart:', e);
        }
    });

    function toggleHideDashboard(movieId) {
        const btn = document.getElementById(`btn-${movieId}`);
        const badge = document.getElementById(`badge-${movieId}`);

        btn.disabled = true;

        fetch(`/movie/toggle-hide/${movieId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json',
            },
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    if (data.is_hidden) {
                        badge.className = 'status-badge status-hidden';
                        badge.innerText = 'Hidden';
                        btn.innerHTML = '<i class="fas fa-eye"></i> Show';
                        btn.className = 'btn-toggle btn-secondary';
                        btn.style = '';
                    } else {
                        badge.className = 'status-badge status-visible';
                        badge.innerText = 'Visible';
                        btn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide';
                        btn.className = 'btn-toggle btn-primary';
                        btn.style = 'background: #e50914; border: none; color: white;';
                    }
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred');
            })
            .finally(() => {
                btn.disabled = false;
            });
    }
</script>
{% endblock %}